x-pgstac-common: &pgstac-common
  PGUSER: username
  POSTGRES_USER: username
  PGPASSWORD: password
  POSTGRES_PASSWORD: password
  PGDATABASE: postgis
  POSTGRES_DB: postgis

services:
  pgstac-base:
    image: captaincoordinates/pgstac-chunker-function-issue:base
    build:
      dockerfile: docker/pgstac/Dockerfile
      context: pgstac
      target: pgstac
    volumes:
      - "./scripts/container:/scripts:ro"
    command: postgres
    healthcheck:
      test: ["CMD", "/scripts/healthcheck.sh"]
      interval: 1s
      timeout: 1s
      retries: 15

  pgstac-16:
    extends: pgstac-base
    image: captaincoordinates/pgstac-chunker-function-issue:16
    build:
      args:
        PG_MAJOR: 16
    ports:
      - 54316:5432
    environment:
      <<: *pgstac-common
    volumes:
      - "./.pgdata/16:/var/lib/postgresql/data:rw"

  pgstac-17:
    extends: pgstac-base
    image: captaincoordinates/pgstac-chunker-function-issue:17
    build:
      args:
        PG_MAJOR: 17
    ports:
      - 54317:5432
    environment:
      <<: *pgstac-common
    volumes:
      - "./.pgdata/17:/var/lib/postgresql/data:rw"

  tester-base:
    image: captaincoordinates/pgstac-chunker-function-issue-tester:base
    build:
      dockerfile: ./tests/Dockerfile
    environment:
      <<: *pgstac-common
    volumes:
      - "./data:/data:ro"

  tester-16:
    extends: tester-base
    image: captaincoordinates/pgstac-chunker-function-issue-tester:16
    environment:
      PGHOST: pgstac-16
    depends_on:
      pgstac-16:
        condition:
          service_healthy
    
  tester-17:
    extends: tester-base
    image: captaincoordinates/pgstac-chunker-function-issue-tester:17
    environment:
      PGHOST: pgstac-17
    depends_on:
      pgstac-17:
        condition:
          service_healthy
